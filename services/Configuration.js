var Configuration,merge,meta,parse,stringify,__slice=[].slice;meta=module.parent.parent.require("../src/meta"),stringify=function(val){return val instanceof Object?JSON.stringify(val):val},parse=function(val,defVal){var type;switch(type=typeof defVal){case"boolean":return val&&"false"!==val;case"object":try{val=JSON.parse(val)}catch(_error){}return val;default:return val}},merge=function(obj1,obj2){var key,val1,val2,_results;_results=[];for(key in obj2)val2=obj2[key],val1=obj1[key],_results.push(obj1.hasOwnProperty(key)?"object"==typeof val2?"object"==typeof val1?merge(val1,val2):obj1[key]=val2:void 0:obj1[key]=val2);return _results},Configuration=function(){function Configuration(data,defCfg,debug,forceUpdate,reset){null==debug&&(debug=!1),null==forceUpdate&&(forceUpdate=!1),null==reset&&(reset=!1),defCfg._version=data.version,this.id=data.name,this.defCfg=defCfg,this.debug=debug,reset?this.reset():this.checkStructure(forceUpdate)}return Configuration.prototype.id="",Configuration.prototype.defCfg={},Configuration.prototype.debug=!1,Configuration.prototype._log=function(){return this.debug?console.log.apply(console,["Configuration ("+this.id+"):"].concat(__slice.call(arguments))):void 0},Configuration.prototype.dbg=function(delay){var _this;return null==delay&&(delay=0),this.debug?delay?(_this=this,setTimeout(function(){return this._log(_this.get())},delay)):this._log(this.get()):void 0},Configuration.prototype.get=function(key,def){var k,obj,v,val,_ref;if(null==key&&(key=null),null==def&&(def=null),!key){obj={},_ref=this.defCfg;for(k in _ref)v=_ref[k],obj[k]=this.get(k,v);return obj}return null==def&&(def=this.defCfg[key]),val=meta.config[""+this.id+":"+key],val?parse(val,def):def},Configuration.prototype.set=function(key,val,cb){return meta.configs.set(""+this.id+":"+key,stringify(val),cb)},Configuration.prototype.setOnEmpty=function(){var key,val,_ref,_results;_ref=this.defCfg,_results=[];for(key in _ref)val=_ref[key],_results.push(meta.configs.setOnEmpty(""+this.id+":"+key,stringify(val)));return _results},Configuration.prototype.reset=function(){var _this;return this._log("Reset initiated."),_this=this,meta.configs.list(function(ignored,obj){var key,val,_ref;for(key in obj)0===key.search(""+_this.id+":")&&meta.configs.remove(key);_ref=_this.defCfg;for(key in _ref)val=_ref[key],_this.set(key,val);return _this.dbg(100)})},Configuration.prototype.checkStructure=function(force){var _this;return force||this.get("_version","0.0.0")!==this.defCfg._version?(this._log("Structure-update initiated."),_this=this,meta.configs.list(function(ignored,obj){var conf,key;conf=_this.get(),merge(conf,_this.defCfg),conf._version=_this.defCfg._version;for(key in obj)0===key.search(""+_this.id+":")&&meta.configs.remove(key);for(key in _this.defCfg)_this.set(key,conf[key]);return _this.dbg(100)})):this.dbg()},Configuration}(),module.exports=Configuration;